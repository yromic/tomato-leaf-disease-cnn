<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tomato Classification</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .container {
        max-width: 450px;
        width: 100%;
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      h1 {
        font-size: 22px;
        margin-bottom: 15px;
        color: #333;
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
      }

      button,
      select {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-size: 15px;
        cursor: pointer;
      }

      button {
        background: #4a90e2;
        color: white;
        font-weight: bold;
      }

      button:hover {
        background: #357ac9;
      }

      select {
        background: #eaeaea;
        color: #333;
      }

      .upload-btn {
        background: #50c878;
        color: white;
        display: block;
        cursor: pointer;
        padding: 12px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: bold;
      }

      .upload-btn:hover {
        background: #3dbb67;
      }

      #image-url-input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      #webcam-container,
      #image-preview {
        margin-top: 20px;
      }

      #webcam-container canvas,
      #image-preview img {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
      }

      #label-container {
        margin-top: 15px;
        font-size: 16px;
      }

      .credit {
        margin-top: 25px;
        font-size: 13px;
        color: #777;
      }

      /* Responsiveness */
      @media (max-width: 480px) {
        .container {
          padding: 15px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Tomato Classification</h1>

      <div class="controls">
        <button onclick="startCamera()">Use Camera</button>

        <select id="camera-select">
          <option value="user">Kamera Depan</option>
          <option value="environment">Kamera Belakang</option>
        </select>

        <label class="upload-btn" for="file-input">Upload Image</label>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none"
        />

        <input
          type="text"
          id="image-url-input"
          placeholder="Paste image URL here"
        />

        <button onclick="loadImageFromURL()">Use Image URL</button>
      </div>

      <div id="webcam-container"></div>
      <div id="image-preview"></div>
      <div id="label-container"></div>

      <div class="credit">Â© 2025 Yromic aka Rifqi</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
      const MODEL_PATH = "./my_model/";
      let model, maxPredictions, webcam;
      let labelContainer = document.getElementById("label-container");

      async function loadModel() {
        if (!model) {
          const modelURL = MODEL_PATH + "model.json";
          const metadataURL = MODEL_PATH + "metadata.json";
          model = await tmImage.load(modelURL, metadataURL);
          maxPredictions = model.getTotalClasses();
        }
        labelContainer.innerHTML = "";
        for (let i = 0; i < maxPredictions; i++) {
          const div = document.createElement("div");
          div.className = "label-box";
          labelContainer.appendChild(div);
        }
      }

      async function startCamera() {
        await loadModel();

        document.getElementById("image-preview").innerHTML = "";
        document.getElementById("webcam-container").innerHTML = "";

        const flip = true;

        const facingMode = document.getElementById("camera-select").value;

        webcam = new tmImage.Webcam(300, 300, flip);

        await webcam.setup({
          facingMode: facingMode,
        });

        await webcam.play();

        document.getElementById("webcam-container").appendChild(webcam.canvas);

        window.requestAnimationFrame(loop);
      }

      async function loop() {
        webcam.update();
        await predictCamera();
        window.requestAnimationFrame(loop);
      }

      async function predictCamera() {
        const prediction = await model.predict(webcam.canvas);
        updateLabels(prediction);
      }

      document
        .getElementById("file-input")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          await loadModel();

          if (webcam) {
            webcam.stop();
          }

          document.getElementById("webcam-container").innerHTML = "";

          let img = document.createElement("img");
          img.src = window.URL.createObjectURL(file);

          img.onload = async function () {
            document.getElementById("image-preview").innerHTML = "";
            document.getElementById("image-preview").appendChild(img);

            const prediction = await model.predict(img);
            updateLabels(prediction);
          };
        });

      function updateLabels(prediction) {
        for (let i = 0; i < maxPredictions; i++) {
          let className = prediction[i].className;
          let prob = (prediction[i].probability * 100).toFixed(1);
          labelContainer.childNodes[
            i
          ].innerHTML = `${className}: <b>${prob}%</b>`;
        }
      }
      async function loadImageFromURL() {
        const url = document.getElementById("image-url-input").value;
        if (!url) {
          alert("Please paste a valid image URL!");
          return;
        }

        await loadModel();

        if (webcam) webcam.stop();

        document.getElementById("webcam-container").innerHTML = "";

        let img = document.createElement("img");
        img.crossOrigin = "anonymous";
        img.src = url;

        img.onload = async function () {
          document.getElementById("image-preview").innerHTML = "";
          document.getElementById("image-preview").appendChild(img);

          const prediction = await model.predict(img);
          updateLabels(prediction);
        };

        img.onerror = function () {
          alert("Image cannot be loaded. Check the URL!");
        };
      }
    </script>
  </body>
</html>
