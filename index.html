<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tomato Classification</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen flex justify-center p-4">
    <div class="w-full max-w-md bg-white shadow-lg rounded-2xl p-6">
      <h1 class="text-2xl font-semibold text-gray-700 text-center mb-4">
        Tomato Classification
      </h1>

      <div class="flex flex-col gap-3">
        <button
          onclick="startCamera()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold"
        >
          Use Camera
        </button>

        <select
          id="camera-select"
          class="w-full px-3 py-3 rounded-xl border bg-gray-100 text-gray-700"
        >
          <option value="user">Kamera Depan</option>
          <option value="environment">Kamera Belakang</option>
        </select>

        <button
          onclick="takeSnapshot()"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-semibold"
        >
          Jepret Foto
        </button>

        <label
          for="file-input"
          class="w-full text-center bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold cursor-pointer"
        >
          Upload Image
        </label>
        <input id="file-input" type="file" accept="image/*" class="hidden" />

        <input
          id="image-url-input"
          type="text"
          placeholder="Paste image URL here"
          class="w-full px-3 py-3 rounded-xl border"
        />

        <button
          onclick="loadImageFromURL()"
          class="w-full bg-gray-800 hover:bg-black text-white py-3 rounded-xl font-semibold"
        >
          Use Image URL
        </button>
      </div>

      <div id="webcam-container" class="mt-5"></div>
      <div id="image-preview" class="mt-5"></div>

      <div id="label-container" class="mt-5 text-lg space-y-1"></div>

      <p class="text-gray-400 text-center text-sm mt-6">
        Â© 2025 Yromic aka Rifqi
      </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <script>
      const MODEL_PATH = "./my_model/";
      let model, maxPredictions, webcam;

      // ===============================
      // LOAD MODEL
      // ===============================
      async function loadModel() {
        if (!model) {
          const modelURL = MODEL_PATH + "model.json";
          const metadataURL = MODEL_PATH + "metadata.json";

          try {
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
          } catch (err) {
            console.error("Model gagal dimuat:", err);
            alert("Gagal memuat model. Pastikan folder model benar.");
            return;
          }
        }

        const labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";
        for (let i = 0; i < maxPredictions; i++) {
          const div = document.createElement("div");
          labelContainer.appendChild(div);
        }
      }

      // ===============================
      // START CAMERA
      // ===============================
      async function startCamera() {
        await loadModel();

        document.getElementById("image-preview").innerHTML = "";
        document.getElementById("webcam-container").innerHTML = "";

        const flip = true;
        const facingMode = document.getElementById("camera-select").value;

        webcam = new tmImage.Webcam(400, 400, flip);

        try {
          await webcam.setup({ facingMode });
          await webcam.play();
        } catch (error) {
          alert("Tidak bisa membuka kamera. Mungkin izin kamera ditolak.");
          return;
        }

        document.getElementById("webcam-container").appendChild(webcam.canvas);
        window.requestAnimationFrame(loop);
      }

      async function loop() {
        if (!webcam) return;
        webcam.update();
        await predict(webcam.canvas);
        window.requestAnimationFrame(loop);
      }

      // ===============================
      // SNAPSHOT / JEPRET FOTO
      // ===============================
      function takeSnapshot() {
        if (!webcam) {
          alert("Kamera belum aktif!");
          return;
        }

        const dataURL = webcam.canvas.toDataURL("image/png");

        webcam.stop();
        webcam = null;

        document.getElementById("webcam-container").innerHTML = "";

        const img = document.createElement("img");
        img.src = dataURL;
        img.className = "w-full rounded-xl";

        img.onload = () => {
          const preview = document.getElementById("image-preview");
          preview.innerHTML = "";
          preview.appendChild(img);
          predict(img);
        };
      }

      // ===============================
      // UPLOAD FILE
      // ===============================
      document
        .getElementById("file-input")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          await loadModel();

          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.className = "w-full rounded-xl";

          img.onload = () => {
            const preview = document.getElementById("image-preview");
            preview.innerHTML = "";
            preview.appendChild(img);
            predict(img);
          };
        });

      // ===============================
      // LOAD IMAGE FROM URL
      // ===============================
      async function loadImageFromURL() {
        await loadModel();

        const url = document.getElementById("image-url-input").value.trim();
        if (!url) return alert("URL kosong!");

        const img = document.createElement("img");
        img.crossOrigin = "anonymous";
        img.src = url;
        img.className = "w-full rounded-xl";

        img.onerror = () =>
          alert("Gambar tidak dapat dimuat. URL tidak valid.");

        img.onload = () => {
          const preview = document.getElementById("image-preview");
          preview.innerHTML = "";
          preview.appendChild(img);
          predict(img);
        };
      }

      // ===============================
      // PREDICTION
      // ===============================
      async function predict(imageElement) {
        if (!model) return;

        const prediction = await model.predict(imageElement);
        const labelContainer = document.getElementById("label-container");

        for (let i = 0; i < maxPredictions; i++) {
          const className = prediction[i].className;
          const prob = (prediction[i].probability * 100).toFixed(1);
          labelContainer.childNodes[
            i
          ].innerHTML = `${className}: <b>${prob}%</b>`;
        }
      }
    </script>
  </body>
</html>
